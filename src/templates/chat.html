{% extends "base.html" %}
{% block content %}

<style>
  .chat-wrapper {
    height: 80vh;
    background: #f8f9fa;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 25px rgba(0, 0, 0, .08);
    display: flex;
  }

  .col-9 {
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .users-sidebar {
    background: #ffffff;
    border-right: 1px solid #e5e7eb;
    height: 100%;
    overflow-y: auto;
  }

  .users-sidebar h6 {
    font-weight: 600;
    color: #374151;
  }

  .chat-header {
    background: #ffffff;
    border-bottom: 1px solid #e5e7eb;
  }

  .chat-body {
    background: #f1f5f9;
    padding: 15px;
    flex-grow: 1;
    overflow-y: auto;
    min-height: 0;
  }

  .chat-bubble {
    max-width: 70%;
    padding: 10px 14px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.4;
  }

  .chat-bubble.me {
    background: #0d6efd;
    color: #fff;
    border-bottom-left-radius: 4px;
  }

  .chat-bubble.other {
    background: #ffffff;
    color: #111827;
    border-bottom-right-radius: 4px;
  }

  .chat-input {
    border-top: 1px solid #e5e7eb;
    background: #ffffff;
  }

  .list-group-item {
    border: 1px solid #e5e7eb;
    padding: 12px 16px;
    margin-bottom: 8px;
    font-size: 14px;
  }

  .list-group-item {
    background: #3f76cf;
    border-radius: 8px;
  }

  .list-group-item.selected-user {
    background-color: #ff4d4d !important;
    color: white !important;
    border-radius: 8px;
  }

  .list-group-item:hover {
    background: #78da09;
  }
</style>

<div class="container py-4" x-data="chatApp({{ conversation.id if conversation else 'null' }}, {{ current_user.id }})">
  <div class="row chat-wrapper mx-auto">

    <!-- Users Sidebar -->
    <div class="col-3 users-sidebar p-3">
      <h6 class="mb-3">Online Users</h6>
      <div class="list-group">
        {% for user in users %}
        {% if user.id != current_user.id %}
        <a href="{{ url_for('chat.chat_with', user_id=user.id) }}"
          class="list-group-item list-group-item-action {{ 'selected-user' if other_user and user.id == other_user.id else '' }}">
          {{ user.name }}
        </a>
        {% endif %}
        {% endfor %}
      </div>
    </div>

    <!-- Chat Section -->
    <div class="col-9 d-flex flex-column p-0 h-100">

      <!-- Header -->
      <div class="chat-header px-4 py-3">
        <h5 class="mb-0">Global Chat</h5>
      </div>

      <!-- Messages -->
      <div class="chat-body flex-grow-1" id="chat">
        {% for m in messages %}
        <div
          class="d-flex mb-2 {{ m.sender_id == current_user.id and 'justify-content-end' or 'justify-content-start' }}">
          <div class="chat-bubble {{ m.sender_id == current_user.id and 'me' or 'other' }}">
            {{ m.content }}
          </div>
        </div>
        {% endfor %}
        <template x-for="msg in messages" :key="msg.id">
          <div class="d-flex mb-2" :class="msg.sender_id == userId ? 'justify-content-end' : 'justify-content-start'">
            <div class="chat-bubble" :class="msg.sender_id == userId ? 'me' : 'other'" x-text="msg.content">
            </div>
          </div>
        </template>
      </div>

      <!-- Input -->
      <div class="chat-input p-3">
        <div class="input-group">
          <input type="text" class="form-control rounded-pill" placeholder="Type a message..." x-model="message"
            @keydown.enter="sendMessage" />
          <button class="btn btn-primary rounded-pill ms-2" @click="sendMessage">
            Send
          </button>
        </div>
      </div>

    </div>
  </div>
</div>





<!-- Optional JavaScript; choose one of the two! -->

<!-- Option 1: Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

<!-- Option 2: Separate Popper and Bootstrap JS -->
<!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    -->
<script src="https://cdn.socket.io/4.8.1/socket.io.min.js"
  integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+" crossorigin="anonymous"></script>

<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('chatApp', (conversationId, userId) => ({
      conversationId: conversationId,
      userId: userId,
      message: '',
      socket: null,
      socketId: '',
      messages: [],
      messageBody: '',
      init() {
        this.socket = Alpine.raw(io());

        this.socket.on('connect', () => {
          this.socketId = this.socket.id;

          if (this.conversationId) {
            this.socket.emit('join_conversation', this.conversationId);
          }

        });

        this.socket.on('message', (msg) => {
          this.messages.push(msg);
          this.scrollToBottom();
        });

        // Scroll to bottom on initial load
        this.$nextTick(() => {
          this.scrollToBottom();
        });
      },
      scrollToBottom() {
        this.$nextTick(() => {
          const chat = document.getElementById('chat');
          if (chat) {
            chat.scrollTop = chat.scrollHeight;
          }
        });
      },
      sendMessage() {
        if (this.message.trim() === '') return;

        // send message to backend
        this.socket.emit('message', {
          text: this.message,
          conversation_id: this.conversationId
        });

        // empty input
        this.message = '';


      }
    }));
  });

</script>

{% endblock %}